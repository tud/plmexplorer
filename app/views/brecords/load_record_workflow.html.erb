<div id="workflow">
	<% chk_label_id= 0; level_id = 0 %>
	<% @record.relproc.blevels.each do |level| %>
		<h3>
			<% if level == @current_level %>
				<a href="#" id="current_level" data-level="<%=level_id%>">&rArr; 
			<% else %>
				<a href="#"> 
			<% end %>
			<%=level.bname%></a>
		</h3>
		<% level_id += 1 %>
		<div>
			<% promotion = @record.bpromotions.find_by_blevel(level.bname) %>
			<% if promotion && level <= @current_level %>
				<em>Promoted to <%=level.bname%> level on <%=promotion.bpromdate.asctime%> by <%=promotion.buser%></em><br><br>
			<% end %>
			<% if level.next %>
				<% @record.blevel(level.next.bname).bpromchks.each do |chk| %>
					<% checked = @record.bchk(chk.bname,level.next.bname) %>
					<% if checked && checked.bchkdate %>
						<input type="checkbox" id="chk_<%=chk_label_id%>" checked="checked"/><label for="chk_<%=chk_label_id%>"><%=chk.bname%></label> <em>Approved on <%=checked.bchkdate.asctime%> by <%=checked.buser%></em><br/>
					<% else %>
						<input type="checkbox" id="chk_<%=chk_label_id%>" class="<%=level==@current_level ? 'approvable' : 'future_check'%>"/><label for="chk_<%=chk_label_id%>"><%=chk.bname%></label><br/>
					<% end %>
					<% chk_label_id += 1 %>
				<% end %>
			<% end %>
		</div>
	<% end %>
</div>

<div id="dialog_approve" title="Approve / Reject">
	<form action="workflow_approve_submit">
		<fieldset class='inlineLabels'>
			<div class="ctrlHolder">
				Why? <input type="text" size="40"/>
			</div>
			<div id="radio">
				<input type="radio" id="radio_approve" name="radio" checked="checked"/><label for="radio_approve">Approve Check</label>
				<input type="radio" id="radio_cancel" name="radio" /><label for="radio_cancel">Cancel</label>
			</div>
		</fieldset>
	</form>
</div>

<script>
$(function(){
	$('#workflow').accordion({
		header: "h3"
	,	autoHeight:false
	});
	
	var level_id = $('#current_level').attr("data-level");
	
	$('#workflow').accordion("activate", parseInt(level_id));
	
	$("#radio").buttonset();
	
	$("#workflow input:checked").button({ 
		disabled: true
	,	icons: {
			primary:'ui-icon-arrowthick-1-n'
		}
	});
	$("#workflow .future_check").button({
		disabled: true
	});
	$("#workflow .approvable").button({
		disabled: false
	});

	$("#dialog_approve").dialog({
		height: 250
	,	width: 360
	,	modal: true
	,	autoOpen: false
	});

	$('#workflow .approvable').click(function() {
		$('#dialog_approve').dialog("open");
		return false;
	});
	
	$('#radio_cancel').click(function() {
		$('#dialog_approve').dialog("close");
		return false;
	});
});
</script>
